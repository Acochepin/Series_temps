---
title: "SÃ©ries bonbons"
output: pdf_document
date: "2023-04-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
require(zoo)
require(tseries)
library(readr)
library(tidyverse)
library(pander)
require(fUnitRoots)
```

```{r}
datafile <- "valeurs_mensuelles.csv"
data <- read.csv(datafile, sep =";")

data <- data %>% 
  filter(!row_number() %in% c(1, 2, 3))%>%
  select(1,2)

colnames(data)[1] = "dates"
colnames(data)[2] = "prod"

data <- apply(data, 2, rev)
data <- as.data.frame (data)

data$prod <- as.numeric (data$prod)


dates_char <- as.character(data$dates)
dates_char[1];dates_char[length(dates_char)]
dates <- as.yearmon(seq(from=2002+12/12,to=2020+1/12,by=1/12))

prod <- zoo(data$prod,order.by=dates)

```

```{r}
plot(cbind(prod))
```
```{r}
acf(prod)
```
--> pic en 1 : intuition pas stationnaire

```{r}
summary(lm(prod ~ dates))
```
```{r}
help ("adfTest")
```

```{r}
adf <- adfTest (prod, lag=0, type = "ct")
```


```{r}
Qtests <- function(series, k, fitdf=0) {
  pvals <- apply(matrix(1:k), 1, FUN=function(l) {
    pval <- if (l<=fitdf) NA else Box.test(series, lag=l, type="Ljung-Box", fitdf=fitdf)$p.value
    return(c("lag"=l,"pval"=pval))
  })
  return(t(pvals))
}

Qtests(adf@test$lm$residuals, 24, fitdf = length(adf@test$lm$coefficients))
```

```{r}
Qtests(adf@test$lm$residuals, 24, fitdf = length(adf@test$lm$coefficients))


adfTest_valid <- function(series, kmax, type){
  k <- 0
  noautocorr <- 0
  while (noautocorr==0){
    cat(paste0("ADF with ",k," lags: residuals OK? "))
    adf <- adfTest(series, lags=k, type=type)
    pvals <- Qtests(adf@test$lm$residuals, 24, fitdf = length(adf@test$lm$coefficients))[,2]
    if (sum(pvals<0.05,na.rm=T)==0) {
      noautocorr <- 1; cat("OK \n")}
    else cat("nope \n")
    k <- k+1
  }
  return(adf)
}

adf <- adfTest_valid(prod,24,type="ct")
Qtests(adf@test$lm$residuals, 24, fitdf = length(adf@test$lm$coefficients))
adf
```


